# GOST V3 入门系列（五）：规则与策略（把“能跑”升级成“可控”）

> 本篇定位：**把策略讲透**  
> 目标：学会用规则把流量“可控化”：
>
> - 该走哪条路（直连 / 走链路 / 走哪条链路）
> - 该绕过什么（内网/局域网/特定目标不走代理）
> - DNS 在哪发生、怎么解析（影响分流、隐私与可用性）
> - 多节点时怎么选（稳定性/成本/体验）

---

## 0. 先把“规则与策略”放回流水线里（避免乱配）

回忆第一篇那条流水线：

- **入站（Listener）**：从哪里接住连接
- **处理（Handler/处理逻辑）**：鉴权、识别目的地、套用规则
- **出站/链路（Chain/Hop/Node）**：决定怎么送出去

本篇讲的“规则与策略”，主要发生在两处：

- **处理阶段**：基于“这是谁、要去哪、用什么协议”等信息做判断
- **出站阶段**：基于判断结果，选择“直连/链路/哪条链路/哪个节点/DNS 方式”

> - 入站像“进了交通枢纽的大门”  
> - 规则像“路牌 + 交通警察”  
> - 链路/节点像“你要走的哪条高速、哪个收费站入口”

---

## 1. 规则不是“堆配置”，是把不确定性收敛成可预测路径

### 1.1 一条规则 = **匹配条件** + **动作**

规则：

> **当连接满足某些条件时，我希望它执行某个动作。**

把它拆成两块：

- **匹配条件（Match）**：我在“识别什么”
  - 例如：目标是某域名、某 IP 网段、某端口、某类协议、某个来源……
- **动作（Action）**：我想“怎么处理”
  - 例如：走直连、走某条链路、选择某个节点、使用某种 DNS 解析方式、拒绝/放行……

> 快递分拣规则  
> - 匹配条件：收件地址在北京、加急件、易碎品  
> - 动作：走航空、贴红标、走专线、优先派送

### 1.2 策略的核心：**默认路由 + 少量例外**

新手最容易把自己配崩的方式是：把规则写成“满屏 if-else”，最后谁也说不清“到底会走哪”。

更稳的策略结构通常是：

- **先定一个默认行为**：没匹配到任何例外时，走哪条路
- **再加例外**：把少数“必须特殊对待”的流量明确写出来

> 城市交通  
> - 默认：都走主干道  
> - 例外：校门口限速、施工路段绕行、救护车优先

### 1.3 规则的“设计输出物”：自己能读懂的表

在写任何 gost 配置之前，先写一张表（这一步能避免 80% 的后期返工）：

| 优先级 | 匹配条件（人话） | 动作（人话） | 为什么 |
|---|---|---|---|
| 高 | 内网/局域网目标 | 直连（或绕过链路） | 不要绕远路、也避免内网域名解析问题 |
| 中 | 公司业务域名 | 指定链路/指定出口 | 稳定、可控、符合合规 |
| 低 | 其他所有 | 默认出口 | 简化规则，保证可预测 |

> 注意：很多规则系统都按“自上而下、先匹配先执行”，不需要假设 gost 一定如此。  
> 正确做法是：**用一组小测试用例验证版本到底怎么匹配**（第 6 节会给验证方法）。

---

## 2. 你能用哪些“信息维度”来写规则？（先记常见项，再用日志/文档确认）

不同实现能暴露出来的“可匹配字段”会不同。为了避免写错，这里只列**网络代理/转发系统里最常见、且可以通过日志/抓包验证的维度**：

- **目标信息**
  - **目标域名**（如果这条连接是以域名方式发起，且系统仍保留域名）
  - **目标 IP**（最终一定会落到 IP 上）
  - **目标端口**（80/443/22/3306…）
- **来源信息**
  - **来源 IP/网段**（谁连进来）
  - **认证用户名**（如果你启用了鉴权，日志里一般能看到“是谁”）
- **协议/入口信息**
  - 入站类型（HTTP 代理 / SOCKS5 / 端口转发……）

把它们理解成“快递面单上的字段”：  
有的字段一定存在（IP/端口），有的字段可能丢失或被提前解析掉（域名）。

---

## 3. Bypass（绕过）：哪些流量不要走“这条路”

### 3.1 Bypass 的直觉：**让某些流量不进收费站**

很多人把“绕过”理解成“不要代理”。更准确的理解是：

> 对某些目标/流量，**不要走某条链路/某段路径**，而是改走“更合理的路径”（通常是直连，或者走另一条链路）。

> 高速收费站  
> - 大货车（外网业务）上高速  
> - 小区内部通勤（内网/局域网）走支路  
> 你不会让“去隔壁楼”的人也上高速绕一圈。

### 3.2 最常见、也最稳的绕过集合：**内网与本机地址段**

这些地址段是标准网络常识（RFC1918/本地环回/链路本地），在做分流时非常常用：

- **本机环回**：`127.0.0.0/8`
- **私有网段（IPv4）**：
  - `10.0.0.0/8`
  - `172.16.0.0/12`
  - `192.168.0.0/16`
- **链路本地（IPv4）**：`169.254.0.0/16`（常见于无 DHCP 时的自动地址）

> **RFC1918 说明**：RFC1918 是定义私有 IP 地址空间的标准文档，全称是 "Address Allocation for Private Internets"（私有互联网地址分配）。
> 
> **主要内容**：
> - **`10.0.0.0/8`** (10.0.0.0 - 10.255.255.255)：单段最大，约 1600 万个地址，常见于大型企业网络
> - **`172.16.0.0/12`** (172.16.0.0 - 172.31.255.255)：中等规模，约 100 万个地址，常见于中型网络
> - **`192.168.0.0/16`** (192.168.0.0 - 192.168.255.255)：最常见，约 6.5 万个地址，常见于家庭路由器和小型网络
> 
> **为什么重要**：
> - 这些地址不会在公网路由，避免冲突
> - 不同内网可重复使用，节省公网地址
> - 在代理/分流场景中，通常应绕过这些地址，避免内网流量走代理

如果你使用 IPv6，还需要额外考虑：

- 回环：`::1/128`
- 私有/本地范围（如 `fc00::/7` 等）

> 这里没有“一定要绕过哪些 IPv6 段”，因为不同网络与目标差异很大。  
> 建议做法：先把“确实在用的内网 IPv6 段”列出来，再决定是否绕过。

### 3.3 典型需求拆解：三类绕过，分别解决什么问题

- **绕过内网**：避免“访问内网服务还要去外面绕一圈”，也避免内网域名解析在外部失败
- **绕过某些稳定直连的目标**：例如更新源、公司内直连资源（是否需要由你的网络策略决定）
- **绕过某些端口/协议**：例如你明确不希望某类服务走代理（这类更偏“访问控制”，第 6 篇会展开）

### 3.4 验证 Bypass 是否生效：不要靠“感觉更快”，用可观察证据

可以用下面的验证思路（不依赖具体语法）：

- **方法 A：看出口路径是否变化**
  - 选择一个“你能确定直连可达”的内网目标（例如路由器管理页、NAS、内网 Web）
  - 在启用 Bypass 前后分别访问它
  - 观察 gost 的日志里“这次连接走了哪里”（至少应该能看到它没有走你设置的那条链路）

- **方法 B：构造对照组**
  - 选一个必走链路才能访问的外网目标（或你希望走链路的目标）
  - 确保它仍然走链路

> 小提示：如果一时没有可用内网目标，先不要硬做“绕过内网验证”。  
> 可以先把规则表写好，等有目标再验证。**不要为了验证而编一个不存在的内网地址。**

---

## 4. Selector（选择器）：多节点/多出口时怎么选

### 4.1 为什么需要 Selector：多出口不是“多了就更强”

当你有多个可用出口/节点时，必然会遇到选择问题：

- 哪个更稳定？
- 哪个更快？
- 哪个更便宜/更符合策略？
- 某个节点坏了怎么办？

如果你不做选择策略，结果往往是：

- “看似可用，但体验忽好忽坏”
- “坏节点拖累整体”
- “排障时你不知道这次到底走的是哪个节点”

> 外卖骑手派单  
> 有 3 个骑手都能接单，但需要一个规则：优先近的、忙的少的、评分高的。

### 4.2 常见的选择诉求（概念层面）

下面是“代理/负载选择”领域最常见的诉求，可以把它当成**需求清单**：

- **均衡**：让请求分散到多个节点（避免单点压力）
- **偏好**：优先用某个主节点，其他作为备份
- **权重**：不同节点承担不同份额
- **健康/可用性优先**：坏了就不要再选它（是否支持取决于具体实现）
- **质量优先**：优先低延迟/高成功率（是否支持取决于具体实现）


### 4.3 如何确定“你的 V3 到底支持哪些选择策略”（100% 可验证）

只需要做三步：

1. **查当前二进制的帮助信息**
   - 运行 `gost -h/--help`，重点找与 “selector / selection / node / chain” 相关的条目
2. **查官方文档/仓库**
   - 以你的 Release 版本为准（同版本的文档/示例最靠谱）
3. **做一个“可观测”的选择验证**
   - 准备两个出口节点（或两条链路），确保它们的“出口特征”不同（例如出口 IP 不同，或日志能区分）
   - 连续发多次请求，观察每次到底选了谁

### 4.4 Selector 的验证技巧：把“谁被选中”变得可观察

最常用的两类“可观察证据”：

- **证据 1：日志里能看到所选节点/地址**
  - 如果你的日志级别支持打印“选中了哪个 node/addr”，这是最直接的
- **证据 2：外部可见的出口特征变化**
  - 例如访问“显示当前公网出口 IP”的站点（你可以自行选择任何可靠站点）
  - 多次请求出现不同结果，说明确实在不同出口间切换

> 注意：如果使用的是同一个公网 NAT 出口，即使走不同节点，最终公网 IP 也可能一样。  
> 这种情况下，应该以日志为准，而不是以“公网 IP 是否变化”来判断。

---

## 5. Resolver / Hosts：DNS 在哪发生、怎么解析（这是分流成败的关键）

### 5.1 先讲清一个最重要的事实：很多“域名规则”都依赖 DNS 位置

你可能希望写这样的规则：

- `*.company.com` 直连
- `*.example.com` 走链路 A

但前提是：系统在做决策时还能"看见域名"。  
如果域名在更早的地方就被解析成 IP（或者客户端本来就只给 IP），就只能按 IP/网段做规则。

> 你想按"网站名称"（域名，如 `example.com`）来分类流量，但流量里只有"IP 地址"（如 `192.168.1.1`）。  
> 这时候你就无法再按网站名称分类了，只能按 IP 地址来分类。

### 5.2 本地解析 vs 远端解析：差异是什么（只讲确定的）

“DNS 位置差异”会造成的确定影响：

- **隐私与可见性**
  - 本地解析：本地 DNS（通常是你网络里的解析器）能看到你查询了哪些域名
  - 远端解析：本地可能看不到域名查询，但远端解析点会看到
- **分流准确性**
  - 如果想按域名分流，就要确保“做决策的那一侧”还能拿到域名信息
- **可用性（尤其是内网域名/分裂 DNS）**
  - 内网域名常常只能在内网 DNS 解析
  - 如果你把解析放到外部，可能根本解析不出来
- **结果一致性**
  - 同一个域名在不同解析器/不同网络可能解析出不同 IP
  - 你的规则如果按 IP 写，就可能被“解析差异”影响

### 5.3 Hosts 映射：把“某个域名固定映射到某个 IP”（谨慎使用）

Hosts 的作用可以理解为：

> 在“问路”之前，先给你一张小抄：遇到某个名字就按小抄上的地址走。

它的优点：

- 让某些域名解析结果稳定（用于排障、临时绕过 DNS 问题）

它的风险：

- 一旦目标 IP 变化（CDN/容灾/迁移），你的小抄就过期了
- 可能破坏某些服务的就近路由/高可用策略

所以建议：

- **把 hosts 映射当作“排障工具/临时手段”**，不要当成长期架构

### 5.4 如何验证“DNS 到底在哪里发生”（可操作、可重复）

推荐两种验证：

- **方法 A（推荐）：抓包看本机是否发出了 DNS 查询**
  - Windows：用 Wireshark（过滤 `dns`）或系统抓包工具
  - Linux/macOS：用 tcpdump（过滤 53/UDP、DoH/DoT 另算）
  - 做对照实验：同一个域名访问两次，分别用“会让代理端解析的方式”和“本地先解析的方式”（具体怎么触发取决于你的客户端与入口类型）
  - 观察：本机是否出现对应的 DNS 查询包

- **方法 B：用一个“只在内网 DNS 可解析”的域名做实验**
  - 如果把解析放到外部就会失败；如果在内网解析就能成功
  - 这个方法依赖你确实有这样的内网域名，所以不作为通用前提

> 重要提醒：现在很多系统/应用可能使用 DoH/DoT（加密 DNS），抓包时不一定是明文 53 端口。  
> 因此“看不到 53”不等于“没有本地解析”，需要结合应用设置与抓包证据综合判断。

---

## 6. 把规则落地成“可验证、可排障”的配置：一个通用流程

### 6.1 流程概览：先从“最小可验证”开始，逐步加复杂度

1. **先确认基线**：不加任何规则时，你的入站 → 出站是通的（第 2/3 篇的最小例子）
2. **只加一条规则**：只改变一种行为（例如只加“内网绕过”）
3. **为这条规则写一个测试用例**：能明确判断“生效/没生效”
4. **观察证据**：日志/抓包/出口特征三选一或组合
5. **确认后再加下一条**：不要一次性堆十条规则

> 调音台  
> 你一次只拧一个旋钮，才知道是哪个旋钮导致了变化。

### 6.2 给你一套“测试用例清单”（你写规则时同步补齐）

为你的每条规则配 2 个用例：

- **正例**：应该匹配这条规则的目标
- **反例**：不应该匹配这条规则的目标

举例（只讲思路）：

- 规则：内网绕过
  - 正例：`192.168.1.10:80`（你内网的一个服务）
  - 反例：`example.com:80`（外网）

### 6.3 排障时的“分层问法”：三问就能缩小范围

当你发现“策略没按预期工作”，不要立刻改配置。按顺序问：

1. **匹配到了吗？**（我以为会命中的那条规则，真的命中了么）
2. **动作执行了吗？**（命中后，真的按我希望的路径走了么）
3. **执行结果可见吗？**（我用的验证方式，能不能真正反映路径差异）

很多“看起来没生效”的问题，其实是第 3 步：你用的验证指标不敏感（例如两个出口公网 IP 一样）。

---

## 7. 三个最常见、最实用的策略配方

### 配方 A：内网直连 + 外网走默认链路（最通用）

结构：

- 规则 1（高优先级）：内网地址段 → 绕过（直连）
- 规则 2（低优先级）：其他所有 → 默认链路

为什么这么做：

- 内网服务不绕路、也避免内网 DNS 在外部解析失败
- 外网统一走默认链路，行为可预测

### 配方 B：工作域名走专线，其余走默认（最常见的“按域名分流”）

结构：

- 规则 1：`*.company.com` → 链路 Work
- 规则 2：内网地址段 → 直连（可选，但强烈建议）
- 规则 3：其他所有 → 默认链路

关键点：

- 这套配方能不能成功，取决于“做决策时是否还能拿到域名”与“DNS 位置”（见第 5 节）

### 配方 C：主节点 + 备节点（把稳定性做出来）

结构：

- 节点集合：A（主）、B（备）
- 选择策略：优先 A；A 不可用时选 B（是否支持自动切换取决于实现）

关键点：

- **先把“可观测”做出来**：日志能清晰区分到底走了 A 还是 B
- 再谈自动化切换，否则你会陷入“好像切了，又好像没切”的玄学状态

---

## 8. 本篇小结（你应该掌握的 6 件事）

1. **规则 = 匹配条件 + 动作**：先用人话写清楚，再落地配置
2. **策略 = 默认行为 + 少量例外**：别用满屏 if-else 把自己绕晕
3. **Bypass 的本质是“不要走这条路”**：最常见是内网/局域网绕过
4. **Selector 解决“多出口怎么选”**：先把“选中谁”变得可观察
5. **DNS 位置决定很多域名规则能不能成立**：抓包是最可靠的验证方式
6. **落地流程：一次只加一条规则 + 配测试用例 + 看证据**：这样永远不会在黑箱里调参