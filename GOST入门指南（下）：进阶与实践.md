# GOST 入门指南（下）：进阶与实践

---

## 一、链路与多跳

### 1.1 什么是链路？

链路（Chain）就是连接出去时要走的路径。可以是直连，也可以是多跳。

> 就像快递配送路线：
> - 直连 = 从你家直接送到收件人
> - 单跳 = 从你家 → 转运中心 → 收件人
> - 多跳 = 从你家 → 市级转运中心 → 省级转运中心 → 收件人

### 1.2 直连、单跳、多跳

三种链路方式的对比：

```mermaid
%%{init: {'theme':'base', 'themeVariables': {'primaryColor':'#fff','primaryTextColor':'#000','primaryBorderColor':'#333','lineColor':'#333','textColor':'#000'}}}%%
flowchart LR
  subgraph 直连["直连"]
    direction LR
    A1[客户端] -->|直接连接| A2[目标服务]
  end
  
  subgraph 单跳["单跳"]
    direction LR
    B1[客户端] -->|连接| B2[上游节点] -->|连接| B3[目标服务]
  end
  
  subgraph 多跳["多跳"]
    direction LR
    C1[客户端] -->|连接| C2[Hop1节点] -->|连接| C3[Hop2节点] -->|连接| C4[目标服务]
  end
  
  style A1 fill:#fff,stroke:#333,stroke-width:2px,color:#000
  style A2 fill:#fff,stroke:#333,stroke-width:2px,color:#000
  style B1 fill:#fff,stroke:#333,stroke-width:2px,color:#000
  style B2 fill:#fff,stroke:#333,stroke-width:2px,color:#000
  style B3 fill:#fff,stroke:#333,stroke-width:2px,color:#000
  style C1 fill:#fff,stroke:#333,stroke-width:2px,color:#000
  style C2 fill:#fff,stroke:#333,stroke-width:2px,color:#000
  style C3 fill:#fff,stroke:#333,stroke-width:2px,color:#000
  style C4 fill:#fff,stroke:#333,stroke-width:2px,color:#000
  style 直连 fill:#f9f9f9,stroke:#ccc,stroke-width:1px,color:#000
  style 单跳 fill:#f9f9f9,stroke:#ccc,stroke-width:1px,color:#000
  style 多跳 fill:#f9f9f9,stroke:#ccc,stroke-width:1px,color:#000
  
  linkStyle 0 stroke:#333,stroke-width:2px
  linkStyle 1 stroke:#333,stroke-width:2px
  linkStyle 2 stroke:#333,stroke-width:2px
  linkStyle 3 stroke:#333,stroke-width:2px
  linkStyle 4 stroke:#333,stroke-width:2px
  linkStyle 5 stroke:#333,stroke-width:2px
```

#### 直连（0 跳）

直连的意思是：gost 拿到目标地址后，直接连目标。

- 优点：最简单、延迟最低
- 缺点：如果你"直连不通"，链路层面就没法帮你

#### 单跳（1 跳）

单跳的意思是：我先连到一个"上游节点"，再由它去连目标。

> 就像你自己不去超市，而是先把清单交给"跑腿小哥"（上游节点），让他替你去买。

#### 多跳（2+ 跳）

多跳的意思是：上游节点不止一层，连接要经过多个节点才到目标。

> 就像快递配送：
> - 你从家门口把包裹交给快递员（本机入站）
> - 快递员先把包裹送到市级转运中心（Hop1）
> - 市级转运中心再送到省级转运中心（Hop2）
> - 省级转运中心再送到收件人（目标）

### 1.3 如何配置链路？

根据官方文档，配置链路的方式可能因版本而异。正确做法是：

1. 运行 `gost -h` / `gost --help`
2. 在帮助里搜索这些关键词：`forward` / `node` / `chain` / `upstream`
3. 找到"如何声明上游节点/出站"的写法后，按照文档配置

**示例结构**（仅在你的 `gost -h` 确实显示支持类似写法时使用）：

```bash
gost <声明本机入站> <声明上游为Hop1>
```

### 1.4 如何验证链路是否生效？

可以用以下方法验证：

- **方法 A：看上游节点的日志**
  - 如果你能在上游节点上看到"有连接进来"的记录，说明链路生效了

- **方法 B：看出口 IP 是否变化**
  - 有些测试服务会回显"它看到的来源 IP"
  - 如果你直连时看到的是 A，走链路后看到的是上游节点的出口 IP，说明链路生效了

---

## 二、规则与策略

### 2.1 什么是规则？

规则就是：**当连接满足某些条件时，我希望它执行某个动作**。

一条规则 = **匹配条件** + **动作**

规则处理流程示意：

```mermaid
flowchart TD
  A[连接进入] --> B{匹配条件}
  B -->|匹配到规则1| C1[执行动作1<br/>如：走链路A]
  B -->|匹配到规则2| C2[执行动作2<br/>如：直连]
  B -->|匹配到规则3| C3[执行动作3<br/>如：拒绝]
  B -->|都不匹配| D[执行默认动作]
  
  C1 --> E[完成]
  C2 --> E
  C3 --> E
  D --> E
```

- **匹配条件**：我在"识别什么"（例如：目标是某域名、某 IP 网段、某端口）
- **动作**：我想"怎么处理"（例如：走直连、走某条链路、拒绝/放行）

> 就像快递分拣规则：
> - 匹配条件：收件地址在北京、加急件、易碎品
> - 动作：走航空、贴红标、走专线、优先派送

### 2.2 Bypass（绕过）

Bypass 的意思是：让某些流量不要走"这条路"，而是改走"更合理的路径"（通常是直连）。

> 就像高速收费站：
> - 大货车（外网业务）上高速
> - 小区内部通勤（内网/局域网）走支路
> 你不会让"去隔壁楼"的人也上高速绕一圈。

#### 常见的内网地址段

根据网络标准（RFC1918），这些地址段是私有网段：

- **本机环回**：`127.0.0.0/8`
- **私有网段（IPv4）**：
  - `10.0.0.0/8`
  - `172.16.0.0/12`
  - `192.168.0.0/16`

这些地址通常应该绕过代理，直接连接。

### 2.3 Selector（选择器）

当你有多个可用出口/节点时，Selector 用于选择"选哪个"。

> 就像外卖骑手派单：
> 有 3 个骑手都能接单，但需要一个规则：优先近的、忙的少的、评分高的。

#### 如何确认 V3 是否支持 Selector？

1. 运行 `gost -h` / `gost --help`
2. 搜索关键词：`selector` / `selection` / `node` / `chain`
3. 如果找到相关参数，再看官方文档了解具体用法

### 2.4 DNS 解析

#### DNS 解析发生在哪？

DNS 解析发生在哪，取决于"域名是谁拿着去发起连接的"。

> 用"通讯录"比喻：
> - 域名（`example.com`）像"人名"
> - IP 像"电话号码"
> - DNS 解析像"查通讯录把人名翻成电话号码"
> 
> 你可以把"DNS 在哪发生"理解成：**到底是谁在查通讯录**。

#### curl 的两种 SOCKS5 用法

- `--socks5`：通常表示"我本机先把域名解析成 IP，再把 IP 交给代理"（也就是**本机查通讯录**）
- `--socks5-hostname`：表示"我把域名原样交给代理，让代理去解析"（也就是**代理侧查通讯录**）

### 2.5 如何配置规则？

根据官方文档，配置规则的方式可能因版本而异。正确做法是：

1. 运行 `gost -h` / `gost --help`
2. 在帮助里搜索这些关键词：`bypass` / `rule` / `selector` / `resolver`
3. 找到相关参数的写法后，按照文档配置

---

## 三、认证与安全

### 3.1 为什么需要认证？

如果你把 gost 的端口对外开放，任何人都可能连上来使用。认证可以确保只有知道用户名密码的人才能使用。

> 就像你家的大门：
> - 没有认证 = 任何人都能进
> - 有认证 = 只有知道密码的人才能进

### 3.2 如何配置认证？

根据官方文档，配置认证的方式可能因版本而异。正确做法是：

1. 运行 `gost -h` / `gost --help`
2. 找入站（通常是 `-L`）的 URL 格式说明
3. 找是否提到用户名/密码写法、或是否有相关参数

**示例**（仅在你的 `gost -h` 确实显示支持类似写法时使用）：

```bash
gost -L socks5://user:pass@127.0.0.1:1080
```

### 3.3 如何验证认证是否生效？

认证验证流程示意：

```mermaid
sequenceDiagram
  participant C as curl客户端
  participant G as gost代理
  
  Note over C,G: 测试1：不带凭据
  C->>G: 连接（无认证信息）
  G->>C: ❌ 拒绝/认证失败
  
  Note over C,G: 测试2：错误凭据
  C->>G: 连接（用户名:wrong 密码:wrong）
  G->>C: ❌ 认证失败
  
  Note over C,G: 测试3：正确凭据
  C->>G: 连接（用户名:user 密码:pass）
  G->>C: ✅ 成功，返回响应
```

**验证步骤**（以 SOCKS5 为例）：

1. **启动带认证的入站**（假设用户名 `user`，密码 `pass`）：

```bash
gost -L socks5://user:pass@127.0.0.1:1080
```

2. **测试 1：不带凭据访问（应该失败）**

```powershell
curl.exe --socks5 127.0.0.1:1080 http://example.com -v
```

应该看到连接被拒绝或认证失败的错误。

3. **测试 2：带错误凭据访问（应该失败）**

```powershell
curl.exe --socks5-user wrong:wrong 127.0.0.1:1080 http://example.com -v
```

应该看到认证失败的错误。

4. **测试 3：带正确凭据访问（应该成功）**

```powershell
curl.exe --socks5-user user:pass 127.0.0.1:1080 http://example.com -v
```

应该能看到正常的 HTTP 响应。

**关键点**：只有测试 1 和测试 2 都失败，测试 3 成功，才能证明认证真的在工作。

### 3.4 监听地址的选择

#### 三种常见绑定方式

- `127.0.0.1:PORT`：只本机可连（最安全，学习/开发首选）
- `内网IP:PORT`：只对某张网卡/某个网段可见
- `0.0.0.0:PORT` 或 `:PORT`：所有网卡都监听（可能对外暴露）

> 你可以把它想象成开店：
> - `127.0.0.1` = 只在家里招待自己
> - `内网IP` = 只对小区开放
> - `0.0.0.0` = 把店开到临街，路过都能进

#### 如何确认监听地址？

启动后立刻查监听，这是最直接、最可靠的验证方式：

Windows（PowerShell）：

```powershell
netstat -ano | findstr :1080
```

Linux/macOS：

```bash
ss -lntp | grep 1080 || netstat -an | grep 1080
```

**关键看"本地地址（Local Address）"这一列**：

- 看到 `127.0.0.1:1080` 或 `::1:1080`：只本机可访问
- 看到 `0.0.0.0:1080` 或 `:::1080`：所有网卡都监听，很可能对外可见

---

## 四、常见问题排查

### 4.1 端口未监听/监听失败

**可能原因**：
1. 端口被占用
2. 启动命令/配置有误
3. 权限不足（Linux/macOS 用低端口时）
4. gost 启动后立刻退出

**排查步骤**：

1. **检查端口是否被占用**

Windows：

```powershell
netstat -ano | findstr :1080
```

Linux/macOS：

```bash
ss -lntp | grep 1080 || netstat -an | grep 1080
```

如果端口被占用，会看到其他进程在使用这个端口。

2. **检查启动命令/配置是否正确**

- 运行 `gost -h` 看命令格式是否正确
- 检查配置文件语法是否正确（如果用了配置文件）

3. **检查权限**

- Linux/macOS 用低端口（<1024）通常需要 root 权限
- 如果权限不足，改用高端口（如 1080、8080）

4. **检查 gost 是否真的在运行**

- Windows：任务管理器看是否有 `gost.exe` 进程
- Linux/macOS：`ps aux | grep gost`

如果进程不存在，说明 gost 启动后立刻退出了，需要看启动时的错误信息。

### 4.2 能连上但无响应

排查流程示意：

```mermaid
flowchart LR
  A[能连上但无响应] --> B{客户端是否走代理?}
  B -->|否| B1[检查客户端配置]
  B -->|是| C{是否配置了认证?}
  C -->|是| D{认证是否正确?}
  C -->|否| E{规则是否匹配?}
  D -->|否| D1[检查认证配置]
  D -->|是| E
  E -->|被拦截| E1[检查Bypass规则]
  E -->|正常| F{出站/链路是否通?}
  F -->|否| F1[检查上游节点]
  F -->|是| G{目标服务是否可用?}
  G -->|否| G1[检查目标服务]
  G -->|是| H[问题已定位]
```

**可能原因**：
1. 客户端没真正走代理
2. 鉴权失败（如果配置了认证）
3. 规则匹配问题（例如被 Bypass 规则拦截）
4. 出站/链路不通
5. 目标服务不可用

**排查步骤**（按顺序排查）：

1. **确认客户端是否真的走代理**

用 `curl` 测试（最可靠）：

```powershell
curl.exe --socks5-hostname 127.0.0.1:1080 http://example.com -v
```

如果 `curl` 能通，说明代理工作正常，问题可能在客户端配置。

2. **检查鉴权（如果配置了认证）**

- 不带凭据访问，应该被拒绝
- 带错误凭据访问，应该被拒绝
- 带正确凭据访问，应该成功

3. **检查规则匹配**

- 如果配置了 Bypass 规则，检查目标是否被绕过
- 如果配置了路由规则，检查规则是否匹配

4. **检查出站/链路**

- 如果是直连，直接访问目标看是否可达
- 如果走链路，检查上游节点是否可达

5. **检查目标服务**

- 不用代理直接访问目标，看是否可达
- 如果直连也不通，问题在目标服务或网络环境

### 4.3 只有某些域名不通

**可能原因**：
1. DNS 解析问题
2. 规则匹配问题（例如域名规则）
3. 目标服务问题（某些域名对应的服务不可用）

**排查步骤**：

1. **检查 DNS 解析**

- 本机能否解析这个域名？
- 解析到哪个 IP？
- 解析是否超时？

Windows：

```powershell
nslookup example.com
```

Linux/macOS：

```bash
dig example.com
```

2. **检查规则匹配**

- 如果配置了域名规则，检查这个域名是否匹配
- 如果配置了 Bypass 规则，检查这个域名是否被绕过

3. **检查目标服务**

- 不用代理直接访问这个域名，看是否可达
- 如果直连也不通，问题在目标服务或 DNS

### 4.4 性能慢/延迟高

**可能原因**：
1. 网络质量差
2. 上游节点慢
3. DNS 解析慢
4. 连接数限制

**排查步骤**：

1. **先看系统资源**（CPU/内存/网络）
   - Windows：任务管理器 → 性能
   - Linux/macOS：`top` 或 `htop`

2. **再看连接数**

Windows：

```powershell
netstat -an | findstr ESTABLISHED
```

Linux/macOS：

```bash
ss -an | grep ESTAB || netstat -an | grep ESTABLISHED
```

3. **再看日志/抓包**

- 看 gost 日志（如果支持）
- 看具体哪一步慢（连接建立、DNS 解析、数据传输）

4. **最后看上游节点**

- 如果上游节点本身就慢，gost 再快也没用

---

## 五、最小复现

### 5.1 为什么要做"最小复现"？

**目的**：把复杂问题简化，找到真正的原因。

> 就像修车：
> - 如果车坏了，不能把所有零件都换一遍
> - 要先找到坏的那个零件
> - 再针对性修理

### 5.2 如何做"最小配置复现"？

最小复现流程示意：

```mermaid
flowchart LR
  A[从最小配置开始] --> B[测试是否正常]
  B -->|正常| C[加一项配置]
  B -->|异常| H[问题已定位]
  C --> D[测试是否正常]
  D -->|正常| E{还有配置要加?}
  D -->|异常| F[找到触发点]
  E -->|是| C
  E -->|否| G[所有配置都正常]
  F --> H
  G --> H
```

**步骤**：

1. **从最小配置开始**

用最简单的配置启动 gost（例如：只监听本机，直连）：

```bash
gost -L socks5://127.0.0.1:1080
```

2. **测试是否正常**

用 `curl` 测试：

```powershell
curl.exe --socks5-hostname 127.0.0.1:1080 http://example.com -v
```

如果正常，说明基础功能没问题。

3. **逐项加回配置**

一次只加一个配置项，每加一项就测试一次：

- 加认证 → 测试
- 加链路 → 测试
- 加规则 → 测试
- ...

4. **找到触发点**

如果加某个配置后问题出现，这个配置就是触发点。

---

## 六、小结

1. 理解链路的概念（直连、单跳、多跳）
2. 理解规则与策略（Bypass、Selector、DNS）
3. 配置认证，并验证认证是否生效
4. 排查常见问题（端口未监听、能连上但无响应、只有某些域名不通、性能慢）
5. 用"最小复现"的方法简化复杂问题

**重要提醒**：

- 遇到不同 V3 Release 在参数/行为上有差异时，用 `gost --help` 和官方文档自查
- 不确定的内容，以官方文档为准
- 如果配置了认证，一定要验证认证真的在工作
- 如果对外提供服务，建议只监听 `127.0.0.1` 或配置防火墙限制来源
